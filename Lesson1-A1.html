<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartClass - Lección 2: Conexiones Reales</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap');

        :root {
            --navy-tech: #1A1F36;
            --electric-mint: #2CE6B8;
            --sun-coral: #F85F73;
            --blanco-nitido: #F9FAFC;
            --gris-suave: #E5E7EB;
            --gris-medio: #D1D5DB;
            --gris-oscuro: #6B7280;
            --verde-exito: #10B981; 
            --verde-exito-oscuro: #059669; 
            --rojo-error: #EF4444;
            --amarillo-info: #F59E0B;
            --azul-claro-fondo: #EFF6FF;
            --texto-principal: #1F2937;
            --texto-secundario: #4B5563;
            
            --font-principal-fallback: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-principal: 'Outfit', var(--font-principal-fallback);
            --font-titulos: 'Montserrat', var(--font-principal-fallback);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --sidebar-width-desktop: 300px;
            --header-height: 70px; 
        }

        /* Animaciones (sin cambios) */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseFeedback { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        @keyframes tada { 0% {transform: scale(1);} 10%, 20% {transform: scale(0.9) rotate(-3deg);} 30%, 50%, 70%, 90% {transform: scale(1.1) rotate(3deg);} 40%, 60%, 80% {transform: scale(1.1) rotate(-3deg);} 100% {transform: scale(1) rotate(0);} }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(248, 95, 115, 0.6); } 70% { box-shadow: 0 0 0 12px rgba(248, 95, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 95, 115, 0); } }
        @keyframes modal-pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }


        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-principal);
            margin: 0;
            background-color: var(--blanco-nitido);
            color: var(--texto-principal);
            line-height: 1.7;
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: var(--header-height);
        }

        header {
            background-color: var(--navy-tech);
            color: var(--blanco-nitido);
            padding: 0 25px;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            height: var(--header-height);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1002;
            box-shadow: var(--shadow-md);
        }
        .logo { font-family: var(--font-titulos); font-size: 1.8em; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: center; }
        .logo .icon { font-size: 0.9em; margin-right: 8px; color: var(--electric-mint); }
        .mobile-menu-toggle { display: none; font-size: 1.8em; color: var(--blanco-nitido); background: none; border: none; cursor: pointer; padding: 10px; }

        .main-wrapper { display: flex; flex-grow: 1; }

        .sidebar {
            width: var(--sidebar-width-desktop);
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--gris-suave);
            flex-shrink: 0;
            position: sticky; 
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
        }
        .sidebar-header-info { padding: 20px; border-bottom: 1px solid var(--gris-suave); flex-shrink: 0; }
        .sidebar-header-info h1.lesson-title-sidebar { font-family: var(--font-titulos); font-size: 1.3em; color: var(--navy-tech); margin: 0 0 10px 0; font-weight: 600; line-height: 1.3; }
        
        .progress-bar-wrapper { display: flex; align-items: center; gap: 10px; }
        .progress-bar-container-sidebar { flex-grow: 1; background-color: var(--gris-medio); border-radius: 15px; margin-bottom: 0; height: 20px; position: relative; overflow: hidden; }
        .progress-bar-sidebar { width: 0%; height: 100%; background-color: var(--verde-exito); border-radius: 15px; transition: width 0.7s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .progress-percentage-text { font-size: 0.9em; font-weight: 600; color: var(--verde-exito-oscuro); min-width: 40px; text-align: right; }

        .sidebar-menu-container { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .sidebar-menu-container h3 { font-family: var(--font-titulos); color: var(--gris-oscuro); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--gris-medio); display: flex; align-items: center; }
        .sidebar-menu-container h3 .icon { font-size: 1.1em; color: var(--navy-tech); margin-right: 8px; }
        #lessonSectionsMenu { list-style: none; padding: 0; margin: 0; }
        #lessonSectionsMenu li a { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; text-decoration: none; color: var(--texto-secundario); border-radius: 6px; margin-bottom: 4px; transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; font-weight: 500; font-size: 0.9em; }
        #lessonSectionsMenu li a .menu-item-text { display: flex; align-items: center; flex-grow: 1; }
        #lessonSectionsMenu li a .menu-icon { margin-right: 10px; font-size: 1.1em; color: var(--gris-oscuro); width: 20px; text-align: center; transition: color 0.2s ease; }
        #lessonSectionsMenu li a .completed-check { font-size: 1.1em; color: var(--verde-exito-oscuro); margin-left: 8px; font-weight: bold; opacity: 0; transition: opacity 0.3s ease; }
        #lessonSectionsMenu li a.step-completed .completed-check { opacity: 1; }
        #lessonSectionsMenu li a:hover { background-color: var(--gris-suave); color: var(--navy-tech); }
        #lessonSectionsMenu li a:hover .menu-icon { color: var(--navy-tech); }
        #lessonSectionsMenu li a.active { background-color: var(--electric-mint); color: var(--navy-tech) !important; font-weight: 600; box-shadow: var(--shadow-sm); }
        #lessonSectionsMenu li a.active .menu-icon { color: var(--navy-tech); }
        #lessonSectionsMenu li a.active.step-completed .completed-check { color: var(--navy-tech); }


        .content-area { flex-grow: 1; padding: 30px; }
        h2 { font-family: var(--font-titulos); margin-top: 0; margin-bottom: 25px; border-bottom: 3px solid var(--electric-mint); padding-bottom: 10px; font-size: 1.8em; color: var(--navy-tech); display: flex; align-items: center; font-weight: 600; }
        .content-area > .lesson-step:first-of-type > h2 { margin-top: 0; } 
        .lesson-step { background-color: #fff; padding: 25px; margin-bottom: 35px; border-radius: 12px; border: 1px solid var(--gris-suave); box-shadow: var(--shadow-md); animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        .lesson-step p { color: var(--texto-secundario); font-size: 1.05em; margin-bottom: 15px; font-weight: 400; }
        .lesson-step ul { list-style: none; padding-left: 0; }
        
        /* ===== NUEVO: ESTILO PARA ELEMENTOS "HABLABLES" ===== */
        .speakable {
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-block; /* Evita que el hover ocupe toda la línea en algunos elementos */
            padding: 2px 4px;
            margin: -2px -4px;
            border-radius: 4px;
        }
        .speakable:hover {
            background-color: var(--azul-claro-fondo);
        }
        /* Asegurar que las etiquetas de quiz mantengan su hover principal */
        .quiz-options label:hover {
            background-color: #E0F2FE !important;
            border-color: var(--electric-mint) !important; 
            transform: translateX(3px);
        }
        .grammar-table td.speakable {
            display: table-cell; /* Restaurar display para celdas de tabla */
        }
        .reading-text-block .speakable {
            display: block; /* Para que el párrafo completo sea clickeable */
        }
         #section-summaryTips ul li.speakable {
            display: list-item; /* Para que el LI se comporte normal */
            list-style: none;
            padding-left: 35px; /* Restaurar padding original */
        }
        /* ===== FIN NUEVO ===== */

        /* Estilos de tabla para gramática */
        .grammar-table-container { overflow-x: auto; margin-bottom: 20px; }
        .grammar-table { width: 100%; border-collapse: collapse; font-size: 1em; }
        .grammar-table th, .grammar-table td { border: 1px solid var(--gris-medio); padding: 10px 12px; text-align: left; }
        .grammar-table th { background-color: var(--azul-claro-fondo); font-weight: 600; color: var(--navy-tech); }
        .grammar-table td { background-color: var(--blanco-nitido); }
        .grammar-table .pronoun { font-weight: 600; color: var(--sun-coral); }
        .grammar-table .verb { font-weight: 600; color: var(--electric-mint); }
        
        .living-english-tip { background-color: #fff9eb; border: 1px solid #ffe7ba; border-left: 5px solid var(--amarillo-info); padding: 15px 20px; margin: 25px 0; border-radius: 8px; font-size: 0.98em; line-height: 1.6; box-shadow: var(--shadow-sm); }
        .living-english-tip strong { color: #b45309; font-weight: 600; display: block; margin-bottom: 5px; }
        .living-english-tip .icon { color: var(--amarillo-info); font-size: 1.2em; margin-right: 8px; vertical-align: -2px; }

        .phrase-block { background-color: var(--blanco-nitido); border: 1px solid var(--gris-medio); padding: 18px 22px; margin-bottom: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; transition: box-shadow 0.3s ease; }
        .phrase-block:hover { box-shadow: var(--shadow-sm); }
        .phrase-text { font-size: 1.35em; margin-bottom: 10px; flex-basis: 100%; color: var(--texto-principal); font-weight: 500; }
        .phrase-text span.highlight { background-color: #D6EEFF; padding: 0.2em 0.5em; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.2s, transform 0.2s; margin: 0 3px; display: inline-block; }
        .phrase-text span.highlight:hover { background-color: var(--electric-mint); color: var(--navy-tech); transform: translateY(-2px); }
        .phrase-text span.highlight.active { background-color: var(--sun-coral); color: white; transform: scale(1.05); }
        button, .button-like { font-family: var(--font-principal); background-color: var(--electric-mint); color: var(--navy-tech); border: none; padding: 12px 22px; border-radius: 25px; cursor: pointer; font-size: 1.05em; font-weight: 600; transition: all 0.2s ease-out; margin-top: 10px; display: inline-flex; align-items: center; box-shadow: var(--shadow-sm); text-decoration: none; }
        button:hover, .button-like:hover { background-color: #23bba0; transform: translateY(-2px) scale(1.02); box-shadow: var(--shadow-md); }
        button:active, .button-like:active { transform: translateY(0px) scale(0.98); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        button.record-btn { background-color: var(--sun-coral); color: var(--blanco-nitido); }
        button.record-btn:hover { background-color: #e04f62; }
        button.record-btn.recording { background-color: #c0392b; animation: pulse 1.2s infinite ease-in-out; }
        button.mark-completed-btn { background-color: var(--gris-suave); color: var(--texto-secundario); font-size: 0.95em; padding: 10px 18px; font-weight: 500; }
        button.mark-completed-btn.completed { background-color: var(--verde-exito); color: white; cursor: default; font-weight: 600; }
        button.mark-completed-btn.completed:hover { background-color: var(--verde-exito); transform: none; box-shadow: var(--shadow-sm); }
        .icon { font-size: 1.4em; margin-right: 10px; vertical-align: middle; }
        h2 .icon { font-size: 1.7em; color: var(--electric-mint); }
        button .icon { font-size: 1.2em; margin-right: 8px; color: inherit; }
        input[type="text"], input[type="tel"], textarea { font-family: var(--font-principal); width: calc(100% - 26px); padding: 12px; margin-bottom: 12px; border: 2px solid var(--gris-medio); border-radius: 8px; font-size: 1.1em; box-sizing: border-box; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-weight: 400; }
        input[type="text"]:focus, input[type="tel"]:focus, textarea:focus { border-color: var(--electric-mint); box-shadow: 0 0 0 3px rgba(44, 230, 184, 0.3); outline: none; }
        textarea { min-height: 100px; resize: vertical; }
        .feedback { padding: 15px 20px; margin-top: 12px; border-radius: 10px; font-weight: 500; font-size: 1.1em; text-align: center; animation: pulseFeedback 0.5s ease; border-width: 2px; border-style: solid; }
        .feedback.success { background-color: #ECFDF5; color: #065F46; border-color: var(--verde-exito); }
        .feedback.error { background-color: #FEF2F2; color: #991B1B; border-color: var(--rojo-error); }
        .feedback.info { background-color: #EFF6FF; color: #1E40AF; border-color: #60A5FA; }
        .grammar-explanation { background-color: var(--azul-claro-fondo); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid var(--sun-coral); }
        .grammar-explanation p { font-weight: 500; margin-bottom: 10px; }
        .grammar-explanation strong { color: var(--navy-tech); font-weight: 700; }
        
        .vocab-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background-color: var(--blanco-nitido); border: 1px solid var(--gris-suave); border-radius: 8px; }
        .vocab-list-item .vocab-word-details { flex-grow: 1; margin-right: 10px;}
        .vocab-list-item .vocab-word-details strong { font-weight: 600; font-size: 1.1em; display: block; }
        .vocab-list-item .vocab-word-details .translation { color: var(--texto-secundario); font-size: 0.9em; font-style: italic; display:block; }
        .vocab-list-item .vocab-word-details .pronunciation-guide { 
            color: var(--sun-coral); font-size: 0.9em; font-weight: 500; 
            display: block; margin-top: 4px;
        }
        .vocab-list-item button { 
            padding: 5px 8px; font-size: 0.75em; margin-left: 0;
            background-color: var(--gris-suave); color: var(--texto-secundario);
            flex-shrink: 0; min-width: auto;
        }
        .vocab-list-item button:hover { background-color: var(--gris-medio); color: var(--navy-tech); }
        .vocab-list-item button .icon { font-size: 1.2em; margin-right: 3px; }
        
        .reading-text-block { background-color: #fffaf0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe7cc; line-height: 1.8; }
        .reading-text-block p { font-weight: 400; }
        .reading-text-block .highlight-negative { background-color: var(--sun-coral); color: white; padding: 0.1em 0.3em; border-radius: 3px; font-weight: 600; }
        .reading-text-block .highlight-location { background-color: var(--electric-mint); color: var(--navy-tech); padding: 0.1em 0.3em; border-radius: 3px; font-weight: 600; }
        
        #section-summaryTips { background-color: var(--azul-claro-fondo); }
        #section-summaryTips h2 .icon { color: var(--amarillo-info); }
        #section-summaryTips ul { list-style: none; padding-left: 0; }
        #section-summaryTips ul li {
            background-color: transparent; border-left: 4px solid var(--amarillo-info); 
            padding: 10px 15px 10px 35px; 
            margin-bottom: 10px; font-size: 1.05em; position: relative; 
        }
        #section-summaryTips ul li::before { 
            content: "💡"; color: var(--amarillo-info);
            margin-right: 10px; font-size: 1.2em; 
            position: absolute; left: 8px; top: 50%; transform: translateY(-50%); 
        }

        .quiz-question { margin-bottom: 25px; padding: 20px; background-color: var(--blanco-nitido); border-radius: 10px; border: 1px solid var(--gris-suave); box-shadow: var(--shadow-sm); }
        .quiz-question p.question-text { font-weight: 600; margin-bottom: 15px; font-size: 1.15em; color: var(--navy-tech); }
        .quiz-options label { display: block; margin-bottom: 10px; padding: 14px 18px; border: 2px solid var(--gris-medio); border-radius: 25px; cursor: pointer; transition: all 0.2s ease-out; font-size: 1.05em; font-weight: 400; }
        .quiz-options input[type="radio"] { margin-right: 12px; vertical-align: middle; transform: scale(1.2); }
        .quiz-options label.correct { background-color: #D1FAE5 !important; border-color: var(--verde-exito) !important; color: #047857; font-weight: 600; }
        .quiz-options label.incorrect { background-color: #FEE2E2 !important; border-color: var(--rojo-error) !important; color: #B91C1C; font-weight: 500; }
        .explanation { font-size: 0.95em; margin-top: 10px; padding: 10px 12px; border-radius: 6px; background-color: #FFFBEB; color: #713F12; border: 1px solid var(--amarillo-info); font-weight: 400; }
        .explanation .icon { font-size: 1.2em; color: var(--amarillo-info); margin-right: 5px; }
        
        .listening-exercise .conversation { margin-bottom: 20px; padding: 20px; border: 1px dashed var(--gris-medio); border-radius: 10px; background-color: #fdfdff; }
        .listening-exercise .speaker { font-weight: 600; color: var(--navy-tech); margin-right: 5px; }
        .listening-exercise input[type="text"].fill-in-blank-input,
        .short-answer-container input[type="text"] { 
            font-family: var(--font-principal); margin: 0 5px; border: 2px solid var(--electric-mint); 
            border-radius: 6px; padding: 6px 8px; font-size: 1em; 
            background-color: #F0FFFF; width: auto; min-width: 60px;
            text-align: center; font-weight: 400; 
        }

        /* Estilos para el formulario de escritura */
        #writingForm .form-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        #writingForm .form-group { flex: 1 1 250px; }
        #writingForm label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--texto-secundario); font-size: 0.95em; }
        #writingForm input { width: 100%; box-sizing: border-box; }
        
        .ai-interaction { margin-top: 35px; padding: 25px; border: 2px dashed var(--sun-coral); border-radius: 12px; background-color: #FFF7F5; }
        .ai-interaction h2 .icon { color: var(--sun-coral); }
        .ai-interaction textarea { border-color: var(--sun-coral); font-family: var(--font-principal); }
        .ai-interaction #aiResponse { margin-top: 15px; padding: 18px; background-color: var(--blanco-nitido); border: 1px solid var(--gris-suave); border-radius: 10px; min-height: 70px; white-space: pre-wrap; font-family: var(--font-principal); font-size: 1.05em; color: var(--texto-secundario); line-height: 1.6; font-weight: 400; }
        .ai-interaction button { background-color: var(--sun-coral); color: var(--blanco-nitido); font-family: var(--font-principal); }
        .ai-interaction button:hover { background-color: #dd5265; }
        
        /* Estilos de la Ventana Emergente (Modal) */
        #completionOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 31, 54, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #completionModal { background: white; padding: 40px; border-radius: 16px; text-align: center; box-shadow: var(--shadow-lg); animation: modal-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; max-width: 500px; width: 90%; }
        #completionModal .icon-modal { font-size: 4em; display: inline-block; animation: tada 1s; content: '🎉'; margin-bottom: 20px; }
        #completionModal h2 { font-size: 2em; color: var(--navy-tech); border: none; margin-bottom: 10px; justify-content: center; }
        #completionModal p { font-size: 1.2em; color: var(--texto-secundario); margin-bottom: 25px; }
        #completionModal button { background-color: var(--navy-tech); color: white; }

        @media (max-width: 850px) {
            body { padding-top: 0; }
            header { position: static; height: auto; padding: 10px 15px; }
            .logo { font-size: 1.6em; margin: 0; }
            .mobile-menu-toggle { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); z-index: 1003;}
            header .logo { position: absolute; left: 50%; transform: translateX(-50%); }
            .header-placeholder { display: none; }
            .main-wrapper { flex-direction: column; margin-top: 0; height: auto; }
            .sidebar {
                width: 85%; max-width: 280px; position: fixed; 
                top: 0; left: -100%; bottom: 0;
                z-index: 1001; 
                background-color: #f8f9fa;
                transition: left 0.3s ease-in-out;
                border-right: 1px solid var(--gris-medio); 
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
                overflow-y: auto; 
            }
            .sidebar.active { left: 0; }
            .sidebar-header-info { padding: 20px 15px; text-align: left; }
            .sidebar-header-info h1.lesson-title-sidebar { font-size: 1.1em; }
            .progress-bar-container-sidebar { height: 14px; }
            .progress-text-sidebar { line-height: 14px; font-size: 0.7em;}
            .sidebar-menu-container { padding: 15px; flex-grow: 1;}
            .sidebar-menu-container h3 { text-align: left; font-size: 0.9em; }
            #lessonSectionsMenu { display: flex; flex-direction: column; align-items: stretch; }
            #lessonSectionsMenu li a { padding: 10px 15px; font-size: 0.95em; border: none; }
            #lessonSectionsMenu li a .menu-icon { display: inline-block; }
            .content-area { padding: 20px 15px; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
            .sidebar.active ~ .overlay { display: block; }
            h2 { font-size: 1.6em; }
            .phrase-text { font-size: 1.2em; }
            #writingForm .form-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>
    <header id="appHeader">
        <button class="mobile-menu-toggle" aria-label="Toggle menu" onclick="toggleMobileMenu()">☰</button>
        <div class="logo">SMARTCLASS</div>
        <div style="width: 48px;" class="header-placeholder"></div> 
    </header>

    <div class="main-wrapper">
        <aside class="sidebar" id="lessonSidebar">
            <div class="sidebar-header-info">
                <h1 class="lesson-title-sidebar">Lección 2 – Conexiones Reales</h1>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-container-sidebar">
                        <div class="progress-bar-sidebar" id="progressBarSidebar"></div>
                    </div>
                    <span class="progress-percentage-text" id="progressTextSidebar">0%</span>
                </div>
            </div>
            <div class="sidebar-menu-container">
                <h3><span class="icon" style="font-size: 1em;">📖</span> Contenido</h3>
                <nav>
                    <ul id="lessonSectionsMenu">
                        </ul>
                </nav>
            </div>
        </aside>
         <div class="overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>

        <main class="content-area" id="contentArea">
            <p style="font-size: 1.2em; text-align: center; color: var(--texto-secundario); margin-bottom: 30px; font-weight: 500;">
                ¡Hola, creador/a de conexiones! 👋 En esta lección, vamos a aprender a hacer preguntas y a compartir información personal para conocer gente de verdad. ¡Prepárate para romper el hielo! 🧊🔥
            </p>

            <section id="section-step1" class="lesson-step" data-step-id="step1" data-title="Escucha Clave" data-icon="🎧" style="animation-delay: 0.1s;">
                <h2><span class="icon">🎧</span> Melodías de Conexión (Escucha Atenta)</h2>
                <p>Escucha con atención cómo suenan estas preguntas y respuestas. Son la base para conocer a alguien. ¡Haz clic en cada palabra para escucharla por separado!</p>
                <div class="phrase-block">
                    <p class="phrase-text speakable">
                        <span class="highlight" onclick="speakWord('Are', 'en-US', this)">Are</span> 
                        <span class="highlight" onclick="speakWord('you', 'en-US', this)">you</span> 
                        <span class="highlight" onclick="speakWord('from', 'en-US', this)">from</span>
                        <span class="highlight" onclick="speakWord('Canada?', 'en-US', this)">Canada?</span>
                    </p>
                    <button onclick="speakPhrase('Are you from Canada?', 'en-US')"><span class="icon">🔊</span> Escuchar</button>
                </div>
                <div class="phrase-block">
                    <p class="phrase-text speakable">
                        <span class="highlight" onclick="speakWord('No,', 'en-US', this)">No,</span> 
                        <span class="highlight" onclick="speakWord('I\'m', 'en-US', this)">I'm</span> 
                        <span class="highlight" onclick="speakWord('not.', 'en-US', this)">not.</span>
                    </p>
                    <button onclick="speakPhrase('No, I\'m not.', 'en-US')"><span class="icon">🔊</span> Escuchar</button>
                </div>
                <div class="phrase-block">
                    <p class="phrase-text speakable">
                        <span class="highlight" onclick="speakWord('She', 'en-US', this)">She</span> 
                        <span class="highlight" onclick="speakWord('isn\'t', 'en-US', this)">isn't</span> 
                        <span class="highlight" onclick="speakWord('married.', 'en-US', this)">married.</span> 
                    </p>
                    <button onclick="speakPhrase('She isn\'t married.', 'en-US')"><span class="icon">🔊</span> Escuchar</button>
                </div>
                <div class="living-english-tip">
                    <span class="icon">💡</span><strong>Living English:</strong> <span class="speakable">In a real conversation, people usually shorten words. Instead of "is not", you will hear "isn't". Instead of "are not", they will say "aren't". Practicing these contractions will make you sound more natural!</span>
                </div>
                <button class="mark-completed-btn" id="completeStep1Btn" onclick="markStepCompleted('step1', this)"><span class="icon">✔️</span> Completé Escucha</button>
            </section>

            <section id="section-grammar" class="lesson-step" data-step-id="grammar" data-title="Gramática Clave" data-icon="📖" style="animation-delay: 0.2s;">
                <h2><span class="icon">📖</span> Gramática Esencial: Preguntas y Negaciones</h2>
                <p>Para conocer gente, ¡hay que saber preguntar y negar! Aquí te mostramos cómo usar el verbo <strong>"to be"</strong> para hacer preguntas (forma interrogativa) y para decir que algo no es cierto (forma negativa).</p>
                
                <div class="grammar-explanation">
                    <p><strong>Forma Interrogativa (¡A Preguntar!):</strong> Para hacer una pregunta, simplemente cambiamos el orden. ¡El verbo "to be" va primero!</p>
                    <div class="grammar-table-container">
                        <table class="grammar-table">
                            <thead><tr><th>Afirmativo</th><th>Interrogativo</th></tr></thead>
                            <tbody>
                                <tr><td class="speakable"><span class="pronoun">He</span> <span class="verb">is</span> Mexican.</td><td class="speakable"><span class="verb">Is</span> <span class="pronoun">he</span> Mexican?</td></tr>
                                <tr><td class="speakable"><span class="pronoun">You</span> <span class="verb">are</span> German.</td><td class="speakable"><span class="verb">Are</span> <span class="pronoun">you</span> German?</td></tr>
                                <tr><td class="speakable"><span class="pronoun">They</span> <span class="verb">are</span> students.</td><td class="speakable"><span class="verb">Are</span> <span class="pronoun">they</span> students?</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grammar-explanation" style="border-left-color: var(--electric-mint);">
                    <p><strong>Forma Negativa (¡A Negar!):</strong> Para decir "no", solo agregamos <strong>"not"</strong> después del verbo "to be". En conversaciones, casi siempre usamos la forma corta (contracción).</p>
                    <div class="grammar-table-container">
                        <table class="grammar-table">
                             <thead><tr><th>Positivo</th><th>Negativo</th><th>Contracción (¡la más usada!)</th></tr></thead>
                             <tbody>
                                 <tr><td class="speakable">I am</td><td class="speakable">I am not</td><td class="speakable"><strong>I'm not</strong></td></tr>
                                 <tr><td class="speakable">He is</td><td class="speakable">He is not</td><td class="speakable"><strong>He isn't</strong></td></tr>
                                 <tr><td class="speakable">She is</td><td class="speakable">She is not</td><td class="speakable"><strong>She isn't</strong></td></tr>
                                 <tr><td class="speakable">It is</td><td class="speakable">It is not</td><td class="speakable"><strong>It isn't</strong></td></tr>
                                 <tr><td class="speakable">We are</td><td class="speakable">We are not</td><td class="speakable"><strong>We aren't</strong></td></tr>
                                 <tr><td class="speakable">You are</td><td class="speakable">You are not</td><td class="speakable"><strong>You aren't</strong></td></tr>
                                 <tr><td class="speakable">They are</td><td class="speakable">They are not</td><td class="speakable"><strong>They aren't</strong></td></tr>
                             </tbody>
                        </table>
                    </div>
                </div>

                <div class="living-english-tip">
                    <span class="icon">💡</span><strong>Living English:</strong> <span class="speakable">"I'm not" is the only negative contraction for "I am". "I amn't" does not exist. It's a little trick to remember!</span>
                </div>

                <p style="font-weight: 500; margin-top: 20px;"><strong>¡Pequeño Reto!</strong> Responde con respuestas cortas (Ej: Yes, he is / No, they aren't).</p>
                <div class="short-answer-container">
                    <div class="phrase-block">
                        <span class="speakable">1. Is Johnny Depp from Spain?</span> <input type="text" id="short_ans_1" placeholder="Tu respuesta...">
                        <button onclick="checkShortAnswer('short_ans_1', 'No, he isn\'t')">Revisar</button>
                    </div>
                    <div id="feedback_short_ans_1" class="feedback" style="margin-top:0; margin-bottom:10px; font-size:0.9em; display:none;"></div>
                    <div class="phrase-block">
                        <span class="speakable">2. Are Brad Pitt and Angelina Jolie from Italy?</span> <input type="text" id="short_ans_2" placeholder="Tu respuesta...">
                        <button onclick="checkShortAnswer('short_ans_2', 'No, they aren\'t')">Revisar</button>
                    </div>
                    <div id="feedback_short_ans_2" class="feedback" style="margin-top:0; margin-bottom:10px; font-size:0.9em; display:none;"></div>
                </div>
                <button class="mark-completed-btn" id="completeGrammarBtn" onclick="markStepCompleted('grammar', this)"><span class="icon">✔️</span> Entendí la Gramática</button>
            </section>

            <section id="section-vocabWords" class="lesson-step" data-step-id="vocabWords" data-title="Palabras de Contacto" data-icon="🗣️" style="animation-delay: 0.3s;">
                <h2><span class="icon">🗣️</span> Vocabulario: Identidad y Contacto</h2>
                <p>Estas palabras son esenciales para compartir quién eres y cómo contactarte. ¡Escúchalas, repítelas y hazlas tuyas!</p>
                <div id="lessonWordsContainer">
                    </div>
                <div class="living-english-tip">
                     <span class="icon">💬</span><strong>Living English:</strong> <span class="speakable">In many English-speaking countries, it's common to have a "middle name", but it is not always used. The "last name" is also called "surname" or "family name".</span>
                </div>
                <button class="mark-completed-btn" id="completeVocabWordsBtn" onclick="markStepCompleted('vocabWords', this)"><span class="icon">✔️</span> Repasé Palabras Nuevas</button>
            </section>
            
            <section id="section-step2" class="lesson-step" data-step-id="step2" data-title="¡Tu Voz en Acción!" data-icon="🎤" style="animation-delay: 0.4s;">
                <h2><span class="icon">🎤</span> ¡Tu Voz en Acción! (Repite y Responde)</h2>
                <p>¡Es tu turno de hablar! Graba tu voz haciendo preguntas y dando respuestas cortas. Intenta sonar claro y seguro. (Recuerda permitir el uso del micrófono 😉).</p>
                <div class="phrase-block">
                    <p class="phrase-text speakable">Is she Mexican? Yes, she is.</p>
                    <button class="record-btn" onclick="startRecognition('recordFeedback1', this)"><span class="icon">🎤</span> Grabar Ahora</button>
                </div>
                <div id="recordFeedback1" class="feedback" style="display:none;"></div>
                <div class="phrase-block">
                    <p class="phrase-text speakable">Are you from Colombia? No, I'm not.</p>
                    <button class="record-btn" onclick="startRecognition('recordFeedback2', this)"><span class="icon">🎤</span> Grabar Ahora</button>
                </div>
                <div class="living-english-tip">
                    <span class="icon">억</span><strong>Living English:</strong> <span class="speakable">When you ask questions that can be answered with "yes" or "no" (like "Are you...?"), the intonation of your voice should go up at the end of the sentence. Try it, it sounds more natural!</span>
                </div>
                <button class="mark-completed-btn" id="completeStep2Btn" onclick="markStepCompleted('step2', this)"><span class="icon">✔️</span> Completé Práctica Oral</button>
            </section>

            <section id="section-readingComprehension" class="lesson-step" data-step-id="readingComprehension" data-title="Lectura: Jennifer" data-icon="🧐" style="animation-delay: 0.5s;">
                <h2><span class="icon">🧐</span> Lectura y Comprensión: La Historia de Jennifer</h2>
                <p>Lee este texto sobre Jennifer. Presta atención a las <span class="highlight-negative">frases negativas</span> y a la <span class="highlight-location">información de ubicación</span>. Luego, responde las preguntas.</p>
                <div class="reading-text-block" id="jenniferStory"></div>
                <div id="jenniferQuizContainer"></div>
                <button onclick="submitJenniferQuiz()"><span class="icon">✍️</span> Revisar Respuestas</button>
                <div id="jenniferQuizFeedback" class="feedback" style="display:none;"></div>
                <button class="mark-completed-btn" id="completeReadingBtn" onclick="markStepCompleted('readingComprehension', this)"><span class="icon">✔️</span> Entendí la Historia</button>
            </section>
            
            <section id="section-writingForm" class="lesson-step" data-step-id="writingForm_auto" data-title="Tu Ficha Personal" data-icon="📝" style="animation-delay: 0.6s;">
                <h2><span class="icon">📝</span> Tu Ficha Personal (Escritura)</h2>
                <p>¡Es hora de crear tu propia "tarjeta de presentación"! Completa el siguiente formulario con tu información. ¡Esto es súper útil para practicar!</p>
                <form id="writingForm" onsubmit="event.preventDefault(); checkWritingForm();">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fullName"><span class="speakable">1. Full name:</span></label>
                            <input type="text" id="fullName" name="fullName" placeholder="Ej: Maria Perez">
                        </div>
                        <div class="form-group">
                            <label for="age"><span class="speakable">2. Age:</span></label>
                            <input type="text" id="age" name="age" placeholder="Ej: 25">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="address"><span class="speakable">3. Address (street and number):</span></label>
                            <input type="text" id="address" name="address" placeholder="Ej: 50 Mary Street">
                        </div>
                         <div class="form-group">
                            <label for="phone"><span class="speakable">4. Phone number:</span></label>
                            <input type="tel" id="phone" name="phone" placeholder="Ej: (905) 123-4567">
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="nationality"><span class="speakable">5. Nationality:</span></label>
                            <input type="text" id="nationality" name="nationality" placeholder="Ej: Venezuelan">
                        </div>
                        <div class="form-group">
                            <label for="job"><span class="speakable">6. Current job:</span></label>
                            <input type="text" id="job" name="job" placeholder="Ej: Student">
                        </div>
                    </div>
                    <div class="living-english-tip">
                        <span class="icon">📌</span><strong>Living English:</strong> <span class="speakable">Remember that nationalities and the names of countries, cities, and streets are always capitalized in English. It's a golden rule!</span>
                    </div>
                    <button type="submit"><span class="icon">✉️</span> Revisar Mi Ficha</button>
                </form>
                <div id="writingFeedback" class="feedback" style="display:none;"></div>
            </section>

            <section id="section-step4Quiz" class="lesson-step" data-step-id="step4Quiz_auto" data-title="Mini Test General" data-icon="🎯" style="animation-delay: 0.7s;">
                <h2><span class="icon">🎯</span> Desafío de Conocimiento (Mini Test General)</h2>
                <p>Demuestra lo que has aprendido en toda la lección. Elige la opción correcta y ¡conviértete en un maestro de las conexiones!</p>
                <div id="quizContainer"></div>
                <button onclick="submitQuiz()"><span class="icon">🏆</span> ¡Revisar Mis Genialidades!</button>
                <div id="quizFeedback" class="feedback" style="display:none;"></div>
            </section>

            <section id="section-listeningPractice" class="lesson-step listening-exercise" data-step-id="listeningPractice" data-title="Práctica Auditiva" data-icon="👂" style="animation-delay: 0.8s;">
                <h2><span class="icon">👂</span> Práctica de Escucha: Llenando los Vacíos</h2>
                <p>Agudiza el oído. Escucha estos diálogos y luego completa los espacios en blanco. ¡Descifra las conversaciones!</p>
                <div class="conversation" id="convo1">
                    <p><span class="speaker">A:</span> Is she Mexican?</p>
                    <p><span class="speaker">B:</span> No, she isn't. She is from Brazil.</p>
                    <button onclick="listenToConversation('convo1')"><span class="icon">🔊</span> Oír Diálogo 1</button>
                </div>
                <div class="conversation" id="convo2">
                    <p><span class="speaker">A:</span> Are you Israeli?</p>
                    <p><span class="speaker">B:</span> No, I'm not. I am Canadian.</p>
                     <button onclick="listenToConversation('convo2')"><span class="icon">🔊</span> Oír Diálogo 2</button>
                </div>
                <p style="margin-top: 25px; font-weight: 600;">Ahora, ¡a completar! Demuestra tu súper oído:</p>
                <div class="conversation">
                    <p class="speakable"><span class="speaker">A:</span> <input type="text" id="listen_q1" class="fill-in-blank-input" style="width: 50px;" placeholder="_____"> you Israeli?</p>
                    <p class="speakable"><span class="speaker">B:</span> No, <input type="text" id="listen_q2" class="fill-in-blank-input" style="width: 70px;" placeholder="_______">. I am Canadian.</p>
                    <p class="speakable"><span class="speaker">A:</span> Is your last name Millan?</p>
                    <p class="speakable"><span class="speaker">B:</span> No, it <input type="text" id="listen_q3" class="fill-in-blank-input" style="width: 60px;" placeholder="_____">. It is Loaiza.</p>
                    <p class="speakable"><span class="speaker">A:</span> So, are they from Mexico?</p>
                    <p class="speakable"><span class="speaker">B:</span> No, they <input type="text" id="listen_q4" class="fill-in-blank-input" style="width: 70px;" placeholder="_______"> not.</p>
                     <button onclick="checkListeningFillInTheBlanks()"><span class="icon">✍️</span> Comprobar Mis Respuestas</button>
                     <div id="fillInFeedback" class="feedback" style="display:none;"></div>
                </div>
                <button class="mark-completed-btn" id="completeListeningPracticeBtn" onclick="markStepCompleted('listeningPractice', this)"><span class="icon">✔️</span> Completé Desafío Auditivo</button>
            </section>
            
            <section id="section-aiChat" class="lesson-step ai-interaction" data-step-id="aiChat" data-title="Charla con Sparky" data-icon="🤖" style="animation-delay: 0.9s;">
                <h2><span class="icon">🤖</span> Charla con Sparky: ¡A Conectar!</h2>
                <p>¡Es hora de practicar con un amigo IA! Pregúntale a "Sparky" de dónde es o preséntate tú. ¡Te responderá en inglés y podrás tener una conversación real!</p>
                <textarea id="aiUserInput" placeholder="Escribe aquí en inglés... Ej: Hi Sparky! Are you from the USA? I'm from Venezuela."></textarea>
                 <div class="living-english-tip">
                    <span class="icon">💡</span><strong>Living English:</strong> <span class="speakable">You can start a conversation in many ways. Try with: "Hi! Are you from around here?" or "Excuse me, are you the new manager?". Be brave and creative!</span>
                </div>
                <button onclick="askGemini()"><span class="icon">💬</span> Enviar a Sparky</button>
                <div id="aiResponse">Sparky está listo para charlar...</div>
                 <button class="mark-completed-btn" id="completeAIChatBtn" onclick="markStepCompleted('aiChat', this)"><span class="icon">✔️</span> Completé Charla IA</button>
            </section>

            <section id="section-summaryTips" class="lesson-step" data-step-id="summary" data-title="Resumen y Tips" data-icon="🌟" style="animation-delay: 1s;">
                <h2><span class="icon">🌟</span> Resumen y Siguientes Pasos</h2>
                <p>¡Felicidades por completar esta misión de conexiones! Has aprendido herramientas súper poderosas. Repasemos lo más importante:</p>
                <ul>
                    <li class="speakable"><strong>Hacer Preguntas:</strong> Invierte el orden: "<strong>Are you</strong> a student?", "<strong>Is she</strong> from Mexico?".</li>
                    <li class="speakable"><strong>Decir que No:</strong> Usa "not" después del verbo: "I<strong>'m not</strong>", "She <strong>isn't</strong>", "They <strong>aren't</strong>".</li>
                    <li class="speakable"><strong>Vocabulario de Identidad:</strong> Ya sabes palabras como <em>nationality, address, first name, last name</em>.</li>
                    <li class="speakable"><strong>Respuestas Cortas:</strong> "Yes, I am.", "No, he isn't.", "Yes, they are.".</li>
                    <li class="speakable"><strong>Mayúsculas Importantes:</strong> Nombres, países, nacionalidades y ciudades siempre empiezan con mayúscula.</li>
                </ul>
                <div class="living-english-tip">
                    <span class="icon">🚀</span><strong>¡Súper Tip!</strong> La mejor forma de que esto se quede en tu memoria es usarlo. Intenta preguntarle a un amigo en inglés (incluso en broma): "Hey, are you from Japan?". O corrige una idea equivocada: "I'm not tired, I'm energetic!". ¡Cada uso es una victoria!
                </div>
                 <div class="living-english-tip">
                    <span class="icon">🎭</span><strong>Living English - Role-playing:</strong> Imagina que estás en un aeropuerto y conoces a alguien. ¿Qué le preguntarías? ¿Qué le dirías de ti? Practicar estos "mini teatros" en tu mente (¡o en voz alta!) te prepara para situaciones reales.
                </div>
                 <p style="text-align:center; font-weight:600; margin-top:20px;">¡Sigue así! You are doing an amazing job!</p>
            </section>
            
            <div style="text-align: center; margin-top: 40px;">
                <button id="finishLessonBtn" onclick="showCompletionModal()" style="padding: 15px 35px; font-size: 1.2em; background-color: var(--navy-tech); color: var(--blanco-nitido);"><span class="icon">🏁</span> Finalizar Misión</button>
            </div>
        </main>
    </div>
    
    <div id="completionOverlay">
        <div id="completionModal">
            <div class="icon-modal">🎉</div>
            <h2>¡Misión Completada!</h2>
            <p>¡Felicidades! Has dominado el arte de hacer conexiones. Estás 100% listo para brillar en tu próxima clase en vivo.</p>
            <button onclick="hideCompletionModal()">¡Genial!</button>
        </div>
    </div>


    <script>
        // =================================================================================
        // INICIO BLOQUE JAVASCRIPT
        // =================================================================================

        const GEMINI_API_KEY = "AIzaSyBg_DUZ5qx7059tfzbF1frs-HRayN7FrOs"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

        let progress = 0;
        const trackableStepIds = [
            'step1', 'grammar', 'vocabWords', 'step2', 'readingComprehension', 
            'writingForm_auto', 'step4Quiz_auto', 'listeningPractice', 'aiChat'
        ];
        let totalInteractiveSteps = trackableStepIds.length;
        let completedSteps = new Set();

        let progressBarSidebarEl, progressTextSidebarEl, completionOverlayEl, 
            contentAreaEl, sidebarMenuEl, appHeaderEl, lessonSidebarGlobalEl, overlayEl;
        let lessonSections = []; 
        let headerActualHeight = 70; 
        let voices = []; 
        let preferredVoices = {};

        const synth = window.speechSynthesis;
        let recognition;
        let activeUtterance = null;
        let audioCtx;
        let isMobileMenuOpen = false;
        let intersectionObserver;
        let isSpeaking = false; 
        let appInitialized = false;
        let initialWelcomePending = true;

        // --- Funciones de inicialización y UI (sin cambios significativos) ---
        function initializeSpeechAPI() {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                console.warn("Speech Recognition API no es compatible.");
                if (document.readyState === "complete" || document.readyState === "interactive") {
                    disableRecordButtons();
                } else {
                    document.addEventListener('DOMContentLoaded', disableRecordButtons);
                }
            }
            
            function disableRecordButtons() {
                document.querySelectorAll('.record-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="icon">🚫</span> Grab. No Disp.';
                });
            }

            getAndSetVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = getAndSetVoices;
            }
        }
        
        function getAndSetVoices() {
            voices = synth.getVoices();
            if (voices.length > 0) {
                preferredVoices['en-US'] = 
                    voices.find(v => v.lang === 'en-US' && v.name.includes('Google') && (v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('zira') || v.name.toLowerCase().includes('samantha'))) ||
                    voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
                    voices.find(v => v.lang === 'en-US' && v.localService && (v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('zira') || v.name.toLowerCase().includes('samantha'))) ||
                    voices.find(v => v.lang === 'en-US' && v.localService) ||
                    voices.find(v => v.lang === 'en-US') ||
                    voices.find(v => v.lang.startsWith('en-'));

                preferredVoices['es-VE'] = 
                    voices.find(v => v.lang === 'es-VE' && v.localService) ||
                    voices.find(v => v.lang === 'es-VE') ||
                    voices.find(v => v.lang === 'es-ES' && v.name.includes('Google') && v.localService) ||
                    voices.find(v => v.lang === 'es-ES' && v.name.includes('Google')) ||
                    voices.find(v => v.lang.startsWith('es-') && v.localService) ||
                    voices.find(v => v.lang.startsWith('es-'));
                
                if (typeof synth.onvoiceschanged === "function" && synth.onvoiceschanged === getAndSetVoices) {
                    synth.onvoiceschanged = null; 
                }
                if (appInitialized && initialWelcomePending) {
                    initialWelcomePending = false;
                    playWelcomeMessage();
                }
            }
        }
        
        function playSound(type) {
            try {
                if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (!audioCtx) return;

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.06, audioCtx.currentTime + 0.01); 

                let duration = 0.15;
                if (type === 'correct') {
                    oscillator.type = 'sine'; 
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime); 
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.1); 
                } else if (type === 'incorrect') {
                    oscillator.type = 'square'; 
                    oscillator.frequency.setValueAtTime(164.81, audioCtx.currentTime); 
                    oscillator.frequency.linearRampToValueAtTime(110, audioCtx.currentTime + 0.2);
                    duration = 0.25;
                } else if (type === 'tada') {
                    const now = audioCtx.currentTime;
                    gainNode.gain.setValueAtTime(0.1, now);
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(523.25, now); 
                    oscillator.frequency.setValueAtTime(659.25, now + 0.08); 
                    oscillator.frequency.setValueAtTime(783.99, now + 0.16); 
                    oscillator.frequency.setValueAtTime(1046.50, now + 0.24); 
                    duration = 0.4;
                }
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (e) { console.warn("No se pudo reproducir el sonido de feedback:", e); }
        }

        function updateProgressBar() {
            let effectiveCompletedCount = 0;
            completedSteps.forEach(stepId => {
                if (trackableStepIds.includes(stepId)) {
                    effectiveCompletedCount++;
                }
            });
            
            progress = (totalInteractiveSteps > 0) ? (effectiveCompletedCount / totalInteractiveSteps) * 100 : 0;
            if(progressBarSidebarEl && progressTextSidebarEl) {
                progressBarSidebarEl.style.width = progress + '%';
                progressTextSidebarEl.textContent = Math.round(progress) + '%';
            }
        }
        
        function markStepCompleted(stepTrackId, buttonElement) { 
            if (!completedSteps.has(stepTrackId)) {
                completedSteps.add(stepTrackId);
                if(buttonElement) { 
                    buttonElement.classList.add('completed');
                    const iconSpan = buttonElement.querySelector('.icon');
                    buttonElement.innerHTML = (iconSpan ? iconSpan.outerHTML : '') + ' ¡Logrado! ✨';
                    buttonElement.disabled = true;
                }
                
                const sectionIdForMenu = `section-${stepTrackId.replace('_auto','')}`;
                const menuItemLink = sidebarMenuEl.querySelector(`a[href="#${sectionIdForMenu}"]`);

                if (menuItemLink && !menuItemLink.classList.contains('step-completed')) {
                     const checkSpan = document.createElement('span');
                     checkSpan.classList.add('completed-check');
                     checkSpan.textContent = '✔️';
                     menuItemLink.appendChild(checkSpan);
                     menuItemLink.classList.add('step-completed');
                }
                updateProgressBar();
            }
        }
        
        function getHeaderActualHeight() {
            return appHeaderEl ? appHeaderEl.offsetHeight : 70;
        }

        function updateLayoutAndScroll() {
            headerActualHeight = getHeaderActualHeight();
            document.body.style.paddingTop = `${headerActualHeight}px`;
            
            if (lessonSidebarGlobalEl && window.innerWidth > 850) {
                lessonSidebarGlobalEl.style.top = `${headerActualHeight}px`;
                lessonSidebarGlobalEl.style.height = `calc(100vh - ${headerActualHeight}px)`;
            } else if (lessonSidebarGlobalEl) { 
                lessonSidebarGlobalEl.style.top = `0px`; 
                lessonSidebarGlobalEl.style.height = `100vh`;
            }
             if(intersectionObserver && appInitialized) { 
                setupIntersectionObserver();
            }
        }

        function populateSidebar() {
            if (!sidebarMenuEl || !contentAreaEl) return;
            sidebarMenuEl.innerHTML = '';
            lessonSections = Array.from(contentAreaEl.querySelectorAll('section.lesson-step[id^="section-"][data-title]'));
            
            lessonSections.forEach((section) => {
                const title = section.dataset.title;
                const icon = section.dataset.icon || '🔹';
                const sectionHtmlId = section.id;
                const stepTrackId = section.dataset.stepId;

                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${sectionHtmlId}`;
                
                const textSpan = document.createElement('span');
                textSpan.classList.add('menu-item-text');
                textSpan.innerHTML = `<span class="menu-icon">${icon}</span> ${title}`;
                link.appendChild(textSpan);
                
                if (stepTrackId && trackableStepIds.includes(stepTrackId) && completedSteps.has(stepTrackId)) {
                    const checkSpan = document.createElement('span');
                    checkSpan.classList.add('completed-check');
                    checkSpan.textContent = '✔️';
                    link.appendChild(checkSpan);
                    link.classList.add('step-completed');
                }
                
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    scrollToSection(sectionHtmlId);
                    if (window.innerWidth <= 850 && lessonSidebarGlobalEl && lessonSidebarGlobalEl.classList.contains('active')) {
                        toggleMobileMenu();
                    }
                });
                listItem.appendChild(link);
                sidebarMenuEl.appendChild(listItem);
            });
        }
        
        function setupIntersectionObserver() {
            if (intersectionObserver) intersectionObserver.disconnect();
            
            headerActualHeight = getHeaderActualHeight(); 
            const marginTop = headerActualHeight + 10; 
            const marginBottom = Math.max(0, window.innerHeight - marginTop - (window.innerHeight * 0.3)); 

            const options = {
                root: null, 
                rootMargin: `-${marginTop}px 0px -${marginBottom}px 0px`,
                threshold: 0.01 
            };

            intersectionObserver = new IntersectionObserver(entries => {
                let firstIntersectingEntry = null;
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (!firstIntersectingEntry || entry.target.offsetTop < firstIntersectingEntry.target.offsetTop) {
                             firstIntersectingEntry = entry;
                        }
                    }
                });

                if (firstIntersectingEntry) {
                    updateActiveMenuItemDOM(firstIntersectingEntry.target.id);
                } else {
                    let currentScrollY = window.pageYOffset;
                    let closestSectionId = null;
                    let minDistance = Infinity;

                    lessonSections.forEach(section => {
                        const sectionTop = section.offsetTop - headerActualHeight -10; 
                        const distance = Math.abs(currentScrollY - sectionTop);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestSectionId = section.id;
                        }
                    });
                    if (closestSectionId) {
                        updateActiveMenuItemDOM(closestSectionId);
                    }
                }
            }, options);

            lessonSections.forEach(section => {
                if(section) intersectionObserver.observe(section);
            });
        }
        
        function updateActiveMenuItemDOM(activeSectionId) {
             if (!sidebarMenuEl) return;
             sidebarMenuEl.querySelectorAll('a').forEach(a => a.classList.remove('active'));
             const linkToActivate = sidebarMenuEl.querySelector(`a[href="#${activeSectionId}"]`);
             if (linkToActivate) {
                 linkToActivate.classList.add('active');
             }
        }

        function scrollToSection(sectionHtmlId) {
            const section = document.getElementById(sectionHtmlId);
            if (section) {
                const yOffset = -(headerActualHeight + 10); 
                const elementPosition = section.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset + yOffset;
                window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                updateActiveMenuItemDOM(sectionHtmlId);
            }
        }
        
        function toggleMobileMenu() {
            isMobileMenuOpen = !isMobileMenuOpen;
            if (lessonSidebarGlobalEl) {
                lessonSidebarGlobalEl.classList.toggle('active', isMobileMenuOpen);
            }
            if (overlayEl) {
                overlayEl.style.display = isMobileMenuOpen ? 'block' : 'none';
            }
        }
        
        function speakPhrase(text, lang = 'en-US', callback) {
            if (!synth) { if (callback) callback(); return; }
            
            if (synth.speaking) {
                synth.cancel();
            }
            
            setTimeout(() => { 
                if (text !== '') {
                    activeUtterance = new SpeechSynthesisUtterance(text);
                    if (voices.length === 0) voices = synth.getVoices();
                    let voiceToUse = preferredVoices[lang] || preferredVoices[lang.split('-')[0]] || null;
                    if (!voiceToUse && voices.length > 0) {
                        voiceToUse = voices.find(v => v.lang.startsWith(lang.split('-')[0])) || voices.find(v => v.lang.startsWith('en'));
                    }
                    if (voiceToUse) activeUtterance.voice = voiceToUse;
                    activeUtterance.pitch = 1;
                    // ===== MODIFICADO: Velocidad de audio reducida en un 15% =====
                    activeUtterance.rate = (lang.startsWith('es-')) ? 1.05 : 0.85; 
                    
                    let highlightElement = document.querySelector('.phrase-text span.highlight.active');
                    activeUtterance.onstart = () => { isSpeaking = true; };
                    activeUtterance.onend = () => { 
                        isSpeaking = false;
                        activeUtterance = null; 
                        if (highlightElement) highlightElement.classList.remove('active');
                        if (typeof callback === 'function') callback();
                    };
                    activeUtterance.onerror = (event) => { 
                        isSpeaking = false;
                        console.error('SpeechSynthesisUtterance.onerror:', event.error);
                        activeUtterance = null; 
                        if (highlightElement) highlightElement.classList.remove('active');
                        if (typeof callback === 'function') callback();
                    };
                    try { synth.speak(activeUtterance); } catch (e) {
                        console.error("Error al synth.speak:", e);
                        isSpeaking = false;
                        if (typeof callback === 'function') callback();
                    }
                } else { if (typeof callback === 'function') callback(); }
            }, 75); 
        }
        
        function speakWord(word, lang = 'en-US', element) {
            document.querySelectorAll('.phrase-text span.highlight.active').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
            speakPhrase(word, lang); 
        }
        
        let currentFeedbackElem = null;
        let currentRecordButton = null;

        function startRecognition(feedbackElementId, buttonElement) {
            if (!recognition) {
                const feedbackDiv = document.getElementById(feedbackElementId);
                if (feedbackDiv) {
                    feedbackDiv.innerHTML = `<div class="feedback error">Lo siento, la grabación de voz no está disponible en tu navegador. ☹️</div>`;
                    feedbackDiv.style.display = 'block';
                }
                speakPhrase("Lo siento, la grabación de voz no está disponible en tu navegador.", 'es-VE');
                return;
            }
            currentFeedbackElem = document.getElementById(feedbackElementId);
            currentRecordButton = buttonElement;
            if (!currentFeedbackElem || !currentRecordButton) return;

            currentFeedbackElem.style.display = 'block';
            currentFeedbackElem.innerHTML = `<div class="feedback info">¡Adelante, habla! Te estoy escuchando... 🎤</div>`;
            speakPhrase("Adelante, te escucho.", 'es-VE'); 
            currentRecordButton.classList.add('recording');
            currentRecordButton.disabled = true;
            currentRecordButton.innerHTML = '<span class="icon">🛑</span> Grabando...';

            recognition.onresult = function(event) {
                const speechResult = event.results[0][0].transcript;
                currentFeedbackElem.innerHTML = `<div class="feedback success">¡Genial! Escuché: "${speechResult}" 👍. ¡Sigue practicando así!</div>`;
                speakPhrase("Awesome! I heard: " + speechResult + ". Keep practicing like that!", 'en-US');
                playSound('correct');
            }

            recognition.onspeechend = function() {
                if (recognition) recognition.stop();
                if (currentRecordButton && currentRecordButton.classList.contains('recording')) { 
                    currentRecordButton.classList.remove('recording');
                    currentRecordButton.disabled = false;
                    currentRecordButton.innerHTML = '<span class="icon">🎤</span> Grabar de Nuevo';
                }
            }

            recognition.onerror = function(event) {
                let errorMessage = "¡Ups! Algo pasó con la grabación: ";
                let speakMsg = "An error occurred with voice recognition.";
                if (event.error == 'no-speech') {
                    errorMessage += 'No te escuché. ¿Hablaste clarito? Intenta otra vez.';
                    speakMsg = "No te escuché. ¿Hablaste claro? Intenta otra vez.";
                } else if (event.error == 'audio-capture') {
                    errorMessage += 'No puedo acceder al micrófono. ¿Está conectado y con permiso?';
                    speakMsg = "No puedo acceder al micrófono. ¿Está conectado y con permiso?";
                } else if (event.error == 'not-allowed') {
                    errorMessage += 'No me diste permiso para el micrófono. Revisa la configuración de tu navegador.';
                    speakMsg = "No me diste permiso para el micrófono. Revisa la configuración de tu navegador.";
                } else { errorMessage += event.error; }
                if (currentFeedbackElem) currentFeedbackElem.innerHTML = `<div class="feedback error">${errorMessage}</div>`;
                speakPhrase(speakMsg, 'es-VE');
                playSound('incorrect');
                 if (currentRecordButton) {
                    currentRecordButton.classList.remove('recording');
                    currentRecordButton.disabled = false;
                    currentRecordButton.innerHTML = '<span class="icon">🎤</span> Grabar de Nuevo';
                }
            }
            
            try { if (recognition && typeof recognition.start === 'function') recognition.start(); } catch(e) {
                console.error("Error al iniciar reconocimiento:", e);
                if (currentFeedbackElem) currentFeedbackElem.innerHTML = `<div class="feedback error">Error al iniciar grabación: ${e.message}. Intenta recargar.</div>`;
                 if (currentRecordButton) {
                    currentRecordButton.classList.remove('recording');
                    currentRecordButton.disabled = false;
                    currentRecordButton.innerHTML = '<span class="icon">🎤</span> Grabar de Nuevo';
                }
                playSound('incorrect');
            }
        }

        // =================================================================================
        // INICIO CONTENIDO EDITABLE Y FUNCIONES ESPECIÍFICAS DE LA LECCIÓN 2
        // =================================================================================
        
        function checkShortAnswer(inputId, correctAnswer) {
            const userAnswer = document.getElementById(inputId).value.trim().replace(/\.$/, "").toLowerCase();
            const feedbackDiv = document.getElementById(`feedback_${inputId}`);
            const inputField = document.getElementById(inputId);
            if (!feedbackDiv || !inputField) return;
            feedbackDiv.style.display = 'block';

            if (userAnswer === correctAnswer.replace(/\.$/, "").toLowerCase()) {
                feedbackDiv.innerHTML = `<div class="feedback success">¡Respuesta perfecta! <span class="icon">👍</span></div>`;
                speakPhrase("Perfect answer!", "en-US");
                inputField.style.borderColor = 'var(--verde-exito)';
                playSound('correct');
            } else {
                feedbackDiv.innerHTML = `<div class="feedback error">¡Casi! La respuesta correcta es "<strong>${correctAnswer}</strong>". ¡Revisa la tabla de gramática! 😉</div>`;
                speakPhrase("Almost! The correct answer is " + correctAnswer, "en-US");
                inputField.style.borderColor = 'var(--rojo-error)';
                playSound('incorrect');
                inputField.focus();
            }
        }
        
        const lessonVocabularyData = [
            { word: "Nationality", translation: "nacionalidad", pronunciation: "na-sho-ná-li-ti" },
            { word: "Address", translation: "dirección", pronunciation: "á-dres" },
            { word: "Phone number", translation: "número de teléfono", pronunciation: "fóun nóm-ber" },
            { word: "First name", translation: "nombre de pila", pronunciation: "férst néim" },
            { word: "Last name", translation: "apellido", pronunciation: "lást néim" },
            { word: "Age", translation: "edad", pronunciation: "éidch" },
            { word: "City", translation: "ciudad", pronunciation: "sí-ti" },
            { word: "Country", translation: "país", pronunciation: "cáun-tri" },
            { word: "Married", translation: "casado/a", pronunciation: "mé-rrid" },
            { word: "Single", translation: "soltero/a", pronunciation: "sín-gol" },
            { word: "Canadian", translation: "canadiense", pronunciation: "ca-néi-dian" },
            { word: "Mexican", translation: "mexicano/a", pronunciation: "méx-i-can" }
        ];

        function displayLessonVocabulary() {
            const container = document.getElementById('lessonWordsContainer');
            if (!container) return;
            container.innerHTML = '';
            lessonVocabularyData.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('vocab-list-item');
                div.innerHTML = `
                    <div class="vocab-word-details">
                        <strong class="speakable">${item.word}</strong>
                        <span class="translation">(${item.translation})</span>
                        ${item.pronunciation ? `<span class="pronunciation-guide">/ ${item.pronunciation} /</span>` : ''}
                    </div>
                    <button onclick="speakPhrase('${item.word}', 'en-US')" title="Escuchar '${item.word}'"><span class="icon">🔊</span></button>
                `;
                container.appendChild(div);
            });
        }
        
        const jenniferTextData = "Hello, I am Jennifer Richards. I am from Canada. My address is 50 Mary Street, Ontario, Canada L9T 6Z6. My phone number is (905) 693-8956. I am a law student at Summit College and I work part time as a receptionist at the local library. I am a single mom. My daughter Ella is three years old. We love living in this small but beautiful town.";
        
        function displayJenniferStory() {
            const storyContainer = document.getElementById('jenniferStory');
            if (!storyContainer) return;
            const negativeRegex = /\b(am not|is not|isn't|are not|aren't)\b/gi;
            const locationRegex = /\b(Canada|Ontario|Mary Street)\b/gi; 
            
            let highlightedText = jenniferTextData;
            highlightedText = highlightedText.replace(negativeRegex, (match) => `<span class="highlight-negative" title="Frase Negativa">${match}</span>`);
            highlightedText = highlightedText.replace(locationRegex, (match) => `<span class="highlight-location" title="Ubicación">${match}</span>`);
            storyContainer.innerHTML = `<p class="speakable">${highlightedText}</p>`;
        }
        
        const jenniferQuizData = [
            { question: "Is her name Diana Smith?", options: ["Yes, it is", "No, it isn't", "She is Diana Richards"], answer: "No, it isn't", explanation: "El texto dice 'Hello, I am Jennifer Richards', así que su nombre no es Diana Smith." },
            { question: "Is she Mexican?", options: ["Yes, she is", "She is from the USA", "No, she isn't"], answer: "No, she isn't", explanation: "Jennifer dice 'I am from Canada'. Por lo tanto, no es mexicana, es canadiense." },
            { question: "Is she a nurse?", options: ["Yes, she is a nurse", "No, she isn't", "She is a doctor"], answer: "No, she isn't", explanation: "Ella es 'a law student and a part time receptionist' (estudiante de derecho y recepcionista), no enfermera." },
            { question: "Is she married?", options: ["No, she isn't", "Yes, she is", "The text doesn't say"], answer: "No, she isn't", explanation: "El texto dice claramente 'I am a single mom' (soy una madre soltera), por lo que no está casada." }
        ];

        function displayJenniferQuiz() {
            const quizContainer = document.getElementById('jenniferQuizContainer');
            if (!quizContainer) return;
            quizContainer.innerHTML = '';
            jenniferQuizData.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('quiz-question');
                let optionsHTML = `<p class="question-text speakable">${index + 1}. ${q.question}</p><div class="quiz-options">`;
                q.options.forEach(option => {
                    optionsHTML += `<label class="speakable"><input type="radio" name="jennifer_question${index}" value="${option}">${option}</label>`;
                });
                optionsHTML += `</div><div class="explanation" id="jennifer_explanation${index}" style="display:none;"></div>`;
                questionDiv.innerHTML = optionsHTML;
                quizContainer.appendChild(questionDiv);
            });
        }
        function submitJenniferQuiz() {
            const feedbackDiv = document.getElementById('jenniferQuizFeedback');
            if (!feedbackDiv) return;
            feedbackDiv.style.display = 'block';
            let score = 0;
            let allAnswered = true;

            jenniferQuizData.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="jennifer_question${index}"]:checked`);
                const explanationDiv = document.getElementById(`jennifer_explanation${index}`);
                document.querySelectorAll(`input[name="jennifer_question${index}"]`).forEach(optEl => optEl.parentElement.classList.remove('correct', 'incorrect'));
                
                if (selectedOption) {
                    if(explanationDiv) {
                      explanationDiv.innerHTML = `<span class="icon">💡</span> ${q.explanation}`;
                      explanationDiv.style.display = 'block';
                    }
                    if (selectedOption.value === q.answer) {
                        score++;
                        selectedOption.parentElement.classList.add('correct');
                    } else {
                        selectedOption.parentElement.classList.add('incorrect');
                        document.querySelector(`input[name="jennifer_question${index}"][value="${q.answer}"]`).parentElement.classList.add('correct');
                    }
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                feedbackDiv.innerHTML = `<div class="feedback error">¡A responder todo! Te falta alguna pregunta sobre Jennifer. 😉</div>`;
                playSound('incorrect'); return;
            }
            
            let feedbackMessage = '';
            if (score === jenniferQuizData.length) {
                feedbackMessage = `<div class="feedback success">¡Increíble! Entendiste la historia de Jennifer a la perfección. (${score}/${jenniferQuizData.length}) 👩‍🎓 ¡Eres un/a detective de lecturas!</div>`;
                playSound('correct');
            } else {
                feedbackMessage = `<div class="feedback error">Entendiste ${score}/${jenniferQuizData.length} sobre Jennifer. ¡No te preocupes! Revisa las explicaciones y el texto. ¡Puedes lograrlo! 🤓</div>`;
                playSound('incorrect');
            }
            feedbackDiv.innerHTML = feedbackMessage;
        }

        function checkWritingForm() {
            const feedbackDiv = document.getElementById('writingFeedback');
            const form = document.getElementById('writingForm');
            if (!feedbackDiv || !form) return;
            
            const inputs = form.querySelectorAll('input');
            let allFilled = true;
            let firstEmptyInput = null;

            inputs.forEach(input => {
                if (input.value.trim() === '') {
                    allFilled = false;
                    if (!firstEmptyInput) firstEmptyInput = input;
                    input.style.borderColor = 'var(--rojo-error)';
                } else {
                    input.style.borderColor = 'var(--verde-exito)';
                }
            });

            feedbackDiv.style.display = 'block';
            const stepIdForProgress = 'writingForm_auto';

            if (allFilled) {
                feedbackDiv.innerHTML = `<div class="feedback success">¡Excelente! ✨ Has completado tu ficha personal correctamente. ¡Esta información es muy útil!</div>`;
                playSound('correct');
                if (!completedSteps.has(stepIdForProgress)) {
                    markStepCompleted(stepIdForProgress, null);
                }
            } else {
                feedbackDiv.innerHTML = `<div class="feedback error">¡Vamos, casi lo tienes! Parece que faltan algunos campos por llenar. Revisa los que están marcados en rojo. 😉</div>`;
                playSound('incorrect');
                if (firstEmptyInput) firstEmptyInput.focus();
                if (completedSteps.has(stepIdForProgress)) {
                    completedSteps.delete(stepIdForProgress);
                    updateProgressBar();
                }
            }
        }
        
        async function listenToConversation(conversationId) {
            const convoDiv = document.getElementById(conversationId);
            if (!convoDiv) return;
            const lines = Array.from(convoDiv.querySelectorAll('p'));
            const button = convoDiv.querySelector('button');
            if (button) button.disabled = true;

            for (const line of lines) {
                const speakerSpan = line.querySelector('.speaker');
                let textToSpeak = speakerSpan ? line.textContent.replace(speakerSpan.textContent, '').trim() : line.textContent;
                if (textToSpeak) {
                     await new Promise(resolve => speakPhrase(textToSpeak, 'en-US', resolve));
                    await new Promise(resolve => setTimeout(resolve, 150)); 
                }
            }
            if(button) button.disabled = false;
        }

        function checkListeningFillInTheBlanks() {
            const answers = { listen_q1: "are", listen_q2: "i'm not", listen_q3: "isn't", listen_q4: "are" };
            let allCorrect = true;
            const feedbackDiv = document.getElementById('fillInFeedback');
            if (!feedbackDiv) return;
            feedbackDiv.style.display = 'block';

            for (const qid in answers) {
                const inputField = document.getElementById(qid);
                const userAnswer = inputField.value.trim().toLowerCase().replace(/[’`]/g, "'"); // Normalizar apóstrofes
                if (userAnswer === answers[qid]) {
                    inputField.style.borderColor = 'var(--verde-exito)';
                } else {
                    allCorrect = false;
                    inputField.style.borderColor = 'var(--rojo-error)';
                }
            }
            
            if (allCorrect) {
                feedbackDiv.innerHTML = `<div class="feedback success">¡Todas correctas! Eres un detective del audio. 🕵️‍♀️🎉 ¡Muy bien!</div>`;
                playSound('correct');
            } else {
                feedbackDiv.innerHTML = `<div class="feedback error">Algunas respuestas no encajan. Revisa las marcadas en rojo y escucha de nuevo. ¡No te rindas! 🧐</div>`;
                playSound('incorrect');
            }
        }
        
        const quizData = [ 
            { question: "Para preguntar '¿Es él de Venezuela?' de forma correcta, ¿cómo lo dices?", options: ["He is from Venezuela?", "Is from Venezuela he?", "Is he from Venezuela?", "From Venezuela is he?"], answer: "Is he from Venezuela?", explanation: "¡Correcto! Para preguntar, el verbo 'to be' (Is) va al principio, antes del sujeto (he)." },
            { question: "Si quieres decir 'Nosotros no somos de Italia', ¿cuál es la forma más común y natural?", options: ["We not are from Italy", "We are no from Italy", "We aren't from Italy", "We from Italy not"], answer: "We aren't from Italy", explanation: "¡Exacto! La contracción 'aren't' (are not) es la forma más usada en conversaciones reales." },
            { question: "'First name' se refiere a tu:", options: ["Nacionalidad", "Apellido", "Edad", "Nombre de pila"], answer: "Nombre de pila", explanation: "'First name' es tu nombre, como 'Carlos' o 'Ana'. 'Last name' es tu apellido." },
            { question: "Alguien te pregunta 'Are you married?'. Si eres soltero/a, ¿qué respondes?", options: ["Yes, I am.", "No, I am.", "No, I'm not.", "Yes, I not."], answer: "No, I'm not.", explanation: "¡Perfecto! 'No, I'm not' es la respuesta corta y correcta para negar." },
            { question: "Completa la frase: 'Maria _____ Mexican, she is from Spain.'", options: ["is", "are", "isn't", "am not"], answer: "isn't", explanation: "'isn't' (is not) es la negación correcta para 'she'. La frase indica que no es mexicana." }
        ];

        function displayQuiz() {
            const quizContainer = document.getElementById('quizContainer');
            if (!quizContainer) return;
            quizContainer.innerHTML = '';
            quizData.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('quiz-question');
                let optionsHTML = `<p class="question-text speakable">${index + 1}. ${q.question}</p><div class="quiz-options">`;
                q.options.forEach(option => {
                    optionsHTML += `<label class="speakable"><input type="radio" name="question${index}" value="${option}">${option}</label>`;
                });
                optionsHTML += `</div><div class="explanation" id="explanation${index}" style="display:none;"></div>`;
                questionDiv.innerHTML = optionsHTML;
                quizContainer.appendChild(questionDiv);
            });
        }

        function submitQuiz() {
            const feedbackDiv = document.getElementById('quizFeedback');
            if (!feedbackDiv) return;
            feedbackDiv.style.display = 'block';
            let score = 0;
            let allAnswered = true;
            quizData.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                const explanationDiv = document.getElementById(`explanation${index}`);
                document.querySelectorAll(`input[name="question${index}"]`).forEach(l => l.parentElement.classList.remove('correct', 'incorrect'));
                if (selectedOption) {
                    if (explanationDiv) {
                        explanationDiv.innerHTML = `<span class="icon">💡</span> ${q.explanation}`;
                        explanationDiv.style.display = 'block';
                    }
                    if (selectedOption.value === q.answer) {
                        score++;
                        selectedOption.parentElement.classList.add('correct');
                    } else {
                        selectedOption.parentElement.classList.add('incorrect');
                        document.querySelector(`input[name="question${index}"][value="${q.answer}"]`).parentElement.classList.add('correct');
                    }
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                feedbackDiv.innerHTML = `<div class="feedback error">¡Oh, oh! Parece que olvidaste responder alguna pregunta. ¡Revísalas! 🤔</div>`;
                playSound('incorrect'); return;
            }

            const percentageScore = (score / quizData.length) * 100;
            const stepIdForProgress = 'step4Quiz_auto';
            let feedbackMessage = '';

            if (percentageScore >= 70) { 
                feedbackMessage = `<div class="feedback success">¡EXCELENTE TRABAJO! 🥳 Has acertado ${score} de ${quizData.length}. ¡Estás aprendiendo súper rápido!</div>`;
                playSound('correct');
                if (!completedSteps.has(stepIdForProgress)) markStepCompleted(stepIdForProgress, null);
            } else {
                feedbackMessage = `<div class="feedback error">Tienes ${score} de ${quizData.length}. ¡No te preocupes! Aprender es un proceso. Revisa las explicaciones y sigue practicando. ¡Tú puedes! 💪</div>`;
                playSound('incorrect');
                if (completedSteps.has(stepIdForProgress)) { completedSteps.delete(stepIdForProgress); updateProgressBar(); }
            }
            feedbackDiv.innerHTML = feedbackMessage;
        }
        
        async function askGemini() {
            const userInput = document.getElementById('aiUserInput').value;
            const aiResponseDiv = document.getElementById('aiResponse');
            const askButton = document.querySelector('#section-aiChat button:not(.mark-completed-btn)');

            if (!aiResponseDiv || !askButton) return;

            if (GEMINI_API_KEY === "TU_API_KEY_DE_GEMINI_AQUI" || !GEMINI_API_KEY) {
                aiResponseDiv.textContent = "Sparky dice: Para poder conversar, mi creador necesita poner una 'API Key' secreta. ¡Pídele que la revise! 🗝️";
                speakPhrase("Para poder conversar, mi creador necesita una API Key secreta. Pídele que la revise.", 'es-VE');
                return;
            }

            if (!userInput.trim()) {
                aiResponseDiv.textContent = "Sparky dice: ¡Hola! ¿Listo para practicar? Pregúntame de dónde soy o dime tu nacionalidad. 😊";
                speakPhrase("Hello! Ready to practice? Ask me where I'm from, or tell me your nationality.", 'en-US');
                return;
            }
            
            askButton.disabled = true;
            askButton.innerHTML = '<span class="icon">⏳</span> Sparky está pensando...';
            aiResponseDiv.textContent = "Sparky está procesando tu mensaje... 🤔";
            
            const prompt = `Eres "Sparky", un asistente de IA super amigable, divertido y paciente para un estudiante de Venezuela de nivel A1 de inglés. El estudiante está aprendiendo a hacer preguntas y negaciones con el verbo "to be", y vocabulario de información personal (nationality, country, name, city, job, married, single).

            El estudiante te dice: "${userInput}"

            Tu respuesta DEBE ser:
            1. En INGLÉS MUY SENCILLO Y CLARO (A1, frases cortas, vocabulario de la lección).
            2. ¡Extremadamente positivo y motivador! Usa emojis apropiados (🎉👍😊✨🚀🇻🇪).
            3. Si el estudiante te pregunta de dónde eres ("Where are you from?", "Are you from...?"): "Great question! I'm from the internet, so my nationality is 'digital'! 🤖 What about you? Are you from Venezuela?".
            4. Si el estudiante te da su información ("I'm from Venezuela", "I am a student"): "Awesome! So you are Venezuelan! That's a beautiful country! 🇻🇪 I am not a student, I am an AI assistant. What is your job?".
            5. Si usa una negación correctamente ("I am not married"): "Got it! Thanks for sharing. So, you are single. That's cool! 👍".
            6. Si usa una pregunta correctamente ("Are you a student?"): "Excellent question! No, I'm not a student. I'm your AI buddy. Are you a student?".
            7. Si comete un error simple, corrígelo amablemente. Ej: si dice "I no are from Mexico", responde: "Almost! A better way to say that is 'I am not from Mexico'. Keep trying, you are doing great! 👍 So, where are you from?".
            8. Si el input es un simple "hello" o "hi": "Hey there! 👋 I'm Sparky! Let's practice. Ask me a question, like 'Are you from Canada?' or tell me about you!".
            9. Mantén las respuestas cortas (1-3 frases).
            10. **NADA DE ESPAÑOL.** Solo inglés.
            11. Sé un compañero de conversación, haz preguntas de seguimiento para mantener el diálogo.`;

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.7, maxOutputTokens: 150 } }),
                });
                const data = await response.json();
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    let aiText = data.candidates[0].content.parts[0].text;
                    aiResponseDiv.innerHTML = `<span class="speakable">Sparky dice: ${aiText}</span>`;
                    speakPhrase(aiText, 'en-US');
                } else {
                    aiResponseDiv.textContent = "Sparky dice: Mmm, mi cerebro IA tuvo un pequeño cortocircuito. ¿Podrías intentarlo de nuevo? 😅";
                    speakPhrase("Hmm, my AI brain had a little glitch. Could you try that again?", 'en-US');
                }
            } catch (error) {
                console.error("Error al contactar Gemini API:", error);
                aiResponseDiv.textContent = "Sparky dice: ¡Rayos! No pude conectar. Revisa tu internet o la llave mágica (API Key). 🔌";
            } finally {
                if (askButton) {
                    askButton.disabled = false;
                    askButton.innerHTML = '<span class="icon">💬</span> Enviar a Sparky';
                }
            }
        }
        
        function showCompletionModal() {
            if (completedSteps.size < totalInteractiveSteps) {
                const message = '¡Ánimo! Aún te faltan algunos pasos para completar la misión. ¡Tú puedes!';
                speakPhrase(message, 'es-VE');
                alert(message);
                for (const stepId of trackableStepIds) {
                    if (!completedSteps.has(stepId)) {
                        const sectionId = `section-${stepId.replace('_auto','')}`;
                        scrollToSection(sectionId);
                        break;
                    }
                }
            } else {
                completionOverlayEl.style.display = 'flex';
                playSound('tada');
                speakPhrase("Mission Completed! Congratulations!", 'en-US');
            }
        }
        
        function hideCompletionModal() {
            completionOverlayEl.style.display = 'none';
        }
        
        function playWelcomeMessage() {
             let welcomeMessage = "Hello and welcome to Lesson 2! Let's learn how to make real connections. It's going to be great!";
             speakPhrase("¡Hola! Bienvenido a la Lección 2: Conexiones Reales. ¡Vamos a aprender a conversar y conocer gente!", 'es-VE', () => {
                 if(!isSpeaking && synth && !synth.speaking) { 
                     speakPhrase(welcomeMessage, 'en-US');
                 }
             });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            appHeaderEl = document.getElementById('appHeader');
            lessonSidebarGlobalEl = document.getElementById('lessonSidebar');
            overlayEl = document.getElementById('mobileMenuOverlay');
            progressBarSidebarEl = document.getElementById('progressBarSidebar');
            progressTextSidebarEl = document.getElementById('progressTextSidebar');
            completionOverlayEl = document.getElementById('completionOverlay');
            contentAreaEl = document.getElementById('contentArea');
            sidebarMenuEl = document.getElementById('lessonSectionsMenu');

            initializeSpeechAPI();

            const initAppVisualsAndContent = () => {
                if (appInitialized) return; 
                appInitialized = true;

                updateLayoutAndScroll(); 
                window.addEventListener('resize', () => {
                    updateLayoutAndScroll();
                    setupIntersectionObserver();
                });
                
                populateSidebar(); 
                displayQuiz();       
                displayLessonVocabulary();
                displayJenniferStory();
                displayJenniferQuiz();
                updateProgressBar();

                const steps = document.querySelectorAll('.lesson-step');
                steps.forEach((step, index) => {
                    step.style.animationDelay = `${index * 0.05 + 0.1}s`;
                });
            
                setupIntersectionObserver();

                if (initialWelcomePending) { 
                    playWelcomeMessage();
                    initialWelcomePending = false;
                }
                
                // ===== NUEVO: Event listener para elementos "speakable" =====
                const contentAreaForClicks = document.getElementById('contentArea');
                if (contentAreaForClicks) {
                    contentAreaForClicks.addEventListener('click', (event) => {
                        const speakableElement = event.target.closest('.speakable');
                        // Evita que se active al hacer clic en botones, links, inputs o los spans de palabra individual
                        if (speakableElement && !event.target.closest('button, a, input, textarea, .highlight')) {
                            const textToSpeak = speakableElement.innerText.trim();
                            if (textToSpeak) {
                                speakPhrase(textToSpeak, 'en-US');
                            }
                        }
                    });
                }
            };
            
            let voiceLoadAttempts = 0;
            const maxVoiceLoadAttempts = 20; 
            function tryInitWhenVoicesReady() {
                voiceLoadAttempts++;
                if (synth.getVoices().length > 0) {
                    getAndSetVoices();
                    initAppVisualsAndContent();
                } else if (voiceLoadAttempts < maxVoiceLoadAttempts) {
                    setTimeout(tryInitWhenVoicesReady, 150);
                } else {
                    console.warn("SmartClass: No se pudieron cargar las voces de síntesis.");
                    initAppVisualsAndContent(); 
                }
            }

            if (typeof synth.onvoiceschanged === "function") {
                 synth.onvoiceschanged = () => {
                    if (!appInitialized && synth.getVoices().length > 0) {
                        getAndSetVoices();
                        initAppVisualsAndContent(); 
                        synth.onvoiceschanged = null; 
                    }
                 };
                 setTimeout(tryInitWhenVoicesReady, 50); 
            } else {
                tryInitWhenVoicesReady();
            }
        });

    </script>
</body>
</html>
